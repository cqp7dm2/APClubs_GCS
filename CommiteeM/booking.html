<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Classroom Booking</title>

    <!-- Nav bootstap & resources -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-firestore.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>

</head>

<header>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
        <!-- Brand -->
        <a class="navbar-brand" href="home.html">APClubs</a>

        <!-- Links -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="Club_Search_Result.html">Clubs & Society</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Classroom Booking</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="user_events.html">Events</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="feedback_form.html">Enquiry & Feedback</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="club registration form.html">Club Registration</a>
            </li>

            <!-- Dropdown -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbardrop" data-toggle="dropdown">
                    Signed In
                </a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="userProfile.html">My Profile</a>
                    <a class="dropdown-item" id="adminbtn" href="admin/admin.html">Admin</a>
                    <a class="dropdown-item" id="committeebtn" href="CommiteeM/commMember.html">Committee</a>
                    <a class="dropdown-item" href="#" onclick="logout()">Sign Out</a>
                </div>
            </li>
        </ul>
    </nav>
    <!-- Navbar -->

</header>

<body class="bg-light">
    <div>
        <div class="container w-100 h-100 bg-">
            <div class="row align-items-center h-100">
                <div class="col-lg-12">
                    <div class="row">
                        <div class="col">
                            <div class="card shadow mb-3">
                                <div class="card-header py-3">
                                    <!-- <p class="text-primary m-0 font-weight-bold">User Profile</p> -->
                                    <h3 class="text-primary ">Classroom Booking</h3>
                                    <!-- <button onclick= "getinfo()" class="btn btn-primary btn-sm" type="submit" >Get&nbsp;Data</button> -->
                                </div>
                                <div class="card-body">
                                    <!-- <form method = "POST"> -->

                                    <div class="form-row">
                                        <div class="col">
                                            <div class="form-group"><strong>Classroom</strong>
                                                <select id="room" class="form-control" required>
                                                    <option selected="true" disabled="disabled">Choose Room</option>
                                                    <option value="room-A-5-1">Room A-5-1</option>
                                                    <option value="room-A-5-2">Room A-5-2</option>
                                                    <option value="room-A-5-3">Room A-5-3</option>
                                                    <option value="room-A-5-4">Room A-5-4</option>
                                                    <option value="room-A-5-5">Room A-5-5</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="col">
                                            <div class="form-group"><strong>Start Date and Time</strong>
                                                <input type="datetime-local" class="form-control" id="start_datetime"
                                                    name="start_datetime" aria-describedby="datetime-localHelp"
                                                    placeholder="" required>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-group"><strong>End Date and Time</strong>
                                                <input type="datetime-local" class="form-control" id="end_datetime"
                                                    name="end_datetime" aria-describedby="textHelp" required>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="col">
                                            <div class="form-group"><strong>Purpose</strong>
                                                <textarea class="form-control" type="text" id="purpose" rows="3"
                                                    placeholder="Eg: Meetings" required></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <button id="btn_submit" class="btn btn-success btn-sm">Book</button>
                                    </div>
                                </div>
                            </div>

                            <script type="module">


                                var firebaseConfig = {
                                    apiKey: "AIzaSyCtllaNW3ao2Gnel0LjGr00wYoO9dC9c5I",
                                    authDomain: "apclubs-678c7.firebaseapp.com",
                                    databaseURL: "https://apclubs-678c7-default-rtdb.asia-southeast1.firebasedatabase.app",
                                    projectId: "apclubs-678c7",
                                    storageBucket: "apclubs-678c7.appspot.com",
                                    messagingSenderId: "711066755172",
                                    appId: "1:711066755172:web:8187fe865e562d32807f71",
                                    measurementId: "G-NCK9V02TE8"
                                };

                                firebase.initializeApp(firebaseConfig);
                                var database = firebase.database();

                                //Getting Data from Booking
                                var classroom = document.getElementById("room");
                                var db_purpose = document.getElementById("purpose");
                                var db_status = "Pending"

                                var btn = document.getElementById("btn_submit");

                                //Get current date and time
                                var today = new Date();
                                var date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
                                var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
                                var currentTime = date + ' ' + time;
                                var bk_id = Math.floor(Math.random() * Math.floor(Math.random() * Date.now()));
                                var count = 0;
                                var insertCount = 0;


                                btn.onclick = function () {
                                    var startTime = document.getElementById("start_datetime").value;
                                    startTime = startTime.replace("T", " ");
                                    var endTime = document.getElementById("end_datetime").value;
                                    endTime = endTime.replace("T", " ");
                                    getAllUID(startTime, endTime);
                                }

                                function getAllUID(startTime, endTime) {
                                    firebase.database().ref('classroom_booking/').once('value',
                                        function (snapshot) {
                                            var allUID = Object.keys(snapshot.val());
                                            allUID.forEach(initUID);
                                            function initUID(item) {
                                                var uids = item;
                                                console.log(uids);
                                                SelectAllData(classroom, uids, startTime, endTime)
                                            }
                                            console.log(count)
                                            console.log(insertCount)
                                            checkCountInsert(startTime, endTime);

                                        });

                                }

                                function checkCountInsert(startTime, endTime) {
                                    console.log(count)
                                    console.log(insertCount)
                                    if (count == 0 && insertCount > 0) {
                                        insert(startTime, endTime);
                                    }
                                    else {
                                        displayNoAvaliable();
                                    }
                                }

                                function SelectAllData(classroom, uids, startTime, endTime) {
                                    firebase.database().ref('classroom_booking/' + uids + "/").once('value',
                                        function (AllRecords) {
                                            AllRecords.forEach(
                                                function (CurrentRecord) {
                                                    var checkRoom = CurrentRecord.val().room;
                                                    var startDT = CurrentRecord.val().start_datetime;
                                                    var endDT = CurrentRecord.val().end_datetime;

                                                    var chk_startDT = new Date(startDT).getTime();
                                                    var chk_endDT = new Date(endDT).getTime();

                                                    var srtTime = startTime;
                                                    srtTime = new Date(srtTime).getTime();
                                                    var edTime = endTime;
                                                    edTime = new Date(edTime).getTime();

                                                    //console.log(startDT)
                                                    //console.log(endDT)
                                                    //console.log(chk_startDT)
                                                    //console.log(chk_endDT)
                                                    //console.log(srtTime)
                                                    //console.log(edTime)

                                                    if (classroom.value == checkRoom && ((srtTime == chk_startDT && edTime == chk_endDT) || (srtTime > chk_startDT && srtTime < chk_endDT) || (edTime > chk_startDT && edTime < chk_endDT) || (srtTime < chk_startDT && edTime < chk_endDT))) {
                                                        ++count;
                                                        console.log("not insert")
                                                    }
                                                    else {
                                                        ++insertCount;
                                                        console.log("insert")
                                                    }
                                                }
                                            );
                                        });
                                    console.log(insertCount)
                                    console.log(count)
                                }




                                function displayNoAvaliable() {
                                    alert("The Room is Not Available at that moment");
                                    return;
                                }

                                function insert(startTime, endTime) {
                                    firebase.auth().onAuthStateChanged((user) => {
                                        if (user) {
                                            var uids = user.uid;
                                            console.log(uids);
                                            firebase.database().ref('/committee/' + uids).once('value',
                                                function (snapshot) {
                                                    snapshot.forEach(function (childSnapshot) {
                                                        var clubs = childSnapshot.val();
                                                        InsertData(uids, clubs, startTime, endTime);
                                                    });
                                                });
                                        }
                                    });
                                }

                                //Insert Data
                                function InsertData(uids, clubs, startTime, endTime) {
                                    firebase.database().ref("classroom_booking/" + uids + "/" + bk_id).set({
                                        room: classroom.value,
                                        club: clubs,
                                        start_datetime: startTime,
                                        end_datetime: endTime,
                                        createdTime: currentTime,
                                        purpose: db_purpose.value,
                                        status: db_status
                                    }, (error) => {
                                        if (error) {
                                            alert("Booking failed. Please try again");
                                        } else {
                                            alert("Booking successful");
                                            location.reload();
                                        }
                                    })
                                };




                            </script>

                            <script>
                                function logout() {
                                    window.alert("You have signed out successfully");
                                    window.location.href = "login.html";
                                    firebase.auth().signOut().then(() => {
                                    }).catch((error) => {
                                        console.log(error);
                                    });
                                };
                            </script>

</body>

</html>